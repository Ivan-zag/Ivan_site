<!DOCTYPE html>
<html lang="ru">
<head>
     <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="images/icons-16.png" type="image/x-icon">
    <link rel="shortcut icon" href="images/icons-32.png" type="image/x-icon">
</head>
<body>
<div class="overlay-container">
    <div id="navbar-container"></div>
    <div class="container mt-5">
        <div class="card p-4 shadow">
            <h2 class="text-center fw-bold fs-2 mb-4">Панель управления</h2>
            <div class="row">
                <!-- Левая колонка с навигацией -->
                <div class="col-lg-3 col-md-4 mb-4">
                    <div class="card">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item btn-outline-primary text-center" id="news-btn" style="cursor: pointer;">
                                <i class="fas fa-newspaper"></i> Новости
                            </li>
                            <li class="list-group-item btn-outline-primary text-center" id="services-btn" style="cursor: pointer;">
                                <i class="fas fa-church"></i> Богослужения
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Правая колонка с формами редактирования -->
                <div class="col-lg-9 col-md-8">
                    <div id="news-edit" class="edit-section card mb-3 p-3 w-100 d-none">
                        <h3>Редактирование Новости</h3>
                        <button id="addNewsBtn" class="btn btn-outline-primary mt-2 mb-2"><i class="fas fa-plus"></i> Добавить новость</button>
                        <button id="editNewsBtn" class="btn btn-outline-warning mt-2 mb-2"><i class="fas fa-edit"></i> Редактировать новость</button>
                        <button id="deleteNewsBtn" class="btn btn-outline-danger mt-2 mb-2"><i class="fas fa-trash"></i> Удалить новость</button>
                    </div>
                    <div id="services-edit" class="edit-section card mb-3 p-3 w-100 d-none">
                        <h3>Редактирование Богослужения</h3>
                        <button id="addServiceBtn" class="btn btn-outline-primary mt-2 mb-2"><i class="fas fa-plus"></i> Добавить богослужение</button>
                        <button id="deleteServiceBtn" class="btn btn-outline-danger mt-2 mb-2"><i class="fas fa-trash"></i> Удалить богослужение</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- МОДАЛКИ ДЛЯ НОВОСТЕЙ -->
<div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить новость</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label>Заголовок</label>
                        <input type="text" name="title" class="form-control" id="newsTitle" required>
                    </div>
                    <div class="mb-3">
                        <label>Содержимое</label>
                        <textarea class="form-control" name="content" id="newsContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label>Изображение</label>
                        <input type="file" name="imageUrl" class="form-control" id="newsImage">
                    </div>
                    <button type="submit" class="btn btn-outline-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editNewsModal" tabindex="-1" aria-labelledby="editNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать новость</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editNewsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label>Выберите новость</label>
                        <select id="editNewsSelect" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label>Заголовок</label>
                        <input type="text" class="form-control" name="title" id="editNewsTitle" required>
                    </div>
                    <div class="mb-3">
                        <label>Содержимое</label>
                        <textarea class="form-control" name="content" id="editNewsContent" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label>Текущая картинка</label><br>
                        <img id="editNewsImage" src="" style="max-width:240px;" alt="prev" />
                    </div>
                    <div class="mb-3">
                        <label>Заменить картинку</label>
                        <input type="file" name="imageUrl" class="form-control" id="editNewsImageInput">
                    </div>
                    <button type="submit" class="btn btn-outline-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteNewsModal" tabindex="-1" aria-labelledby="deleteNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Удалить новость</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deleteNewsForm">
                    <div class="mb-3">
                        <label>Выберите новость для удаления</label>
                        <select class="form-select" id="newsToDelete" required></select>
                    </div>
                    <button type="submit" class="btn btn-outline-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- МОДАЛКИ ДЛЯ БОГОСЛУЖЕНИЙ -->
<div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить богослужение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="serviceForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label>Файл богослужения (Word)</label>
                        <input type="file" class="form-control" id="serviceFile" name="file" accept=".doc,.docx" required>
                    </div>
                    <div class="mb-3">
                        <label>Название</label>
                        <input type="text" class="form-control" id="serviceTitle" name="title" required>
                    </div>
                    <button type="submit" class="btn btn-outline-primary">Загрузить</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteServiceModal" tabindex="-1" aria-labelledby="deleteServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Удалить богослужение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deleteServiceForm">
                    <div class="mb-3">
                        <label>Выберите богослужение</label>
                        <select class="form-select" id="serviceToDelete" required></select>
                    </div>
                    <button type="submit" class="btn btn-outline-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="page"></div>

<footer class="footer">
    <div class="container text-center">
        <p>&copy; 2025 Храм Архангела Михаила. Все права защищены.</p>
        <p>Контакты: <a href="mailto:info@example.com">info@example.com</a></p>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function() {
    $('#navbar-container').load('navbar.html');

    var newsList = [], serviceList = [];
    var addNewsModal = new bootstrap.Modal($('#addNewsModal')[0]);
    var editNewsModal = new bootstrap.Modal($('#editNewsModal')[0]);
    var deleteNewsModal = new bootstrap.Modal($('#deleteNewsModal')[0]);
    var addServiceModal = new bootstrap.Modal($('#addServiceModal')[0]);
    var deleteServiceModal = new bootstrap.Modal($('#deleteServiceModal')[0]);

    // Меню режимов
    $('#news-btn').click(function() {
        $('.edit-section').addClass('d-none');
        $('#news-edit').removeClass('d-none');
    });
    $('#services-btn').click(function() {
        $('.edit-section').addClass('d-none');
        $('#services-edit').removeClass('d-none');
    });

    // ======== НОВОСТИ ========

    $('#addNewsBtn').click(function() { addNewsModal.show(); });
    $('#newsForm').on('submit', function(e){
        e.preventDefault();
        var fd = new FormData(this);
        $.ajax({
            url: 'https://back.hram48plosk.ru/api/news',
            type: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            success: function() { alert('Новость добавлена!'); addNewsModal.hide(); },
            error: function() { alert('Ошибка добавления новости!'); }
        });
    });

    $('#editNewsBtn').click(function(){
        $.get('https://back.hram48plosk.ru/api/news', function(data){
            newsList = data || [];
            var $s = $('#editNewsSelect').empty();
            newsList.forEach(x => $s.append($('<option>').val(x.id).text(x.title)));
            if(newsList.length) $s.val(newsList[0].id).trigger('change');
            editNewsModal.show();
        });
    });
    $('#editNewsSelect').on('change', function(){
        var id = $(this).val();
        var n = newsList.find(x => x.id == id);
        $('#editNewsTitle').val(n ? n.title : '');
        $('#editNewsContent').val(n ? n.content : '');
        $('#editNewsImage').attr('src', n ? n.imageUrl : '').toggle(!!(n && n.imageUrl));
        $('#editNewsImageInput').val('');
    });
    $('#editNewsForm').on('submit', function(e){
    e.preventDefault();
    var id = $('#editNewsSelect').val();
    var n = newsList.find(x => x.id == id);
    var fd = new FormData();
    fd.append('title', $('#editNewsTitle').val());
    fd.append('content', $('#editNewsContent').val());

    // Добавляем файл только если выбран!
    var selectedFile = $('#editNewsImageInput')[0].files[0];
    if (selectedFile) {
        fd.append('imageUrl', selectedFile);
    }

    $.ajax({
        url:'https://back.hram48plosk.ru/api/news/' + id,
        type:'PUT',
        data: fd,
        processData: false,
        contentType: false,
        success: function(){ alert('Сохранено!'); editNewsModal.hide(); },
        error: function(){ alert('Ошибка!'); }
    });
});


    $('#deleteNewsBtn').click(function(){
        $.get('https://back.hram48plosk.ru/api/news', function(data){
            newsList = data || [];
            var $s = $('#newsToDelete').empty();
            newsList.forEach(x => $s.append($('<option>').val(x.id).text(x.title)));
            deleteNewsModal.show();
        });
    });
    $('#deleteNewsForm').on('submit', function(e){
        e.preventDefault();
        var id = $('#newsToDelete').val();
        $.ajax({
            url:'https://back.hram48plosk.ru/api/news/'+id,
            type:'DELETE',
            success: function(){ alert('Удалено!'); deleteNewsModal.hide(); },
            error:function(){ alert('Ошибка!'); }
        });
    });

    // ======= БОГОСЛУЖЕНИЯ ==========

    $('#addServiceBtn').click(function() { addServiceModal.show(); });
    $('#serviceForm').on('submit', function(e){
        e.preventDefault();
        var fd = new FormData(this);
        $.ajax({
            url: 'https://back.hram48plosk.ru/api/schedule/upload',
            type: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            success: function() { alert('Богослужение загружено!'); addServiceModal.hide(); },
            error: function() { alert('Ошибка!'); }
        });
    });

    var lastServiceId; // Объявление переменной для хранения ID последнего богослужения

$('#deleteServiceBtn').click(function(){
    $.get('https://back.hram48plosk.ru/api/schedule/last', function(data){
        lastServiceId = data.id; // Сохраняем ID последнего богослужения
        if (confirm(`Вы уверены, что хотите удалить богослужение с ID ${lastServiceId}?`)) {
            deleteService(lastServiceId);
        }
    });
});

// Функция для удаления богослужения
function deleteService(id) {
    $.ajax({
        url: 'https://back.hram48plosk.ru/api/schedule/' + id,
        type: 'DELETE',
        success: function(){
            alert('Богослужение удалено!');
            deleteServiceModal.hide();
            // Обновление интерфейса, например: обновить список богослужений или скрыть удалённое
        },
        error: function(){
            alert('Ошибка при удалении богослужения!');
        }
    });
}

});
</script>
</body>
</html>
